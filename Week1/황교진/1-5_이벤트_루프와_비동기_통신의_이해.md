# 1.5 이벤트 루프와 비동기 통신의 이해 
- 동기(synchronous): 직렬 방식으로 작업을 처리
    - 요청이 시작된 이후에는 무조건 응답을 받은 이후에 다른 작업을 처리할 수 있다. 그동안 다른 모든 작업은 대기한다.
- 비동기(asynchronous): 병렬 방식으로 작업을 처리
    - 요청을 시작한 후 응답에 상관없이 다음 작업이 이루어지며, 한 번에 여러 작업이 실행될 수 있다.
- 자바스크립트는 싱글 스레드에서 작동한다. → 한 번에 단 하나의 작업만, 그리고 동기 방식으로만 처리할 수 있다.
    - 하지만 실제로는 싱글 스레드 기반의 자바스크립트에서도 많은 양의 비동기 작업이 이루어지고 있다.

## 1.5.1 싱글 스레드 자바스크립트 
- 프로세스 : 프로그램을 구동해 프로그램의 상태가 메모리상에서 실행되는 작업 단위
- 스레드 : 하나의 프로세스에서는 여러 개의 스레드를 만들 수 있고, 스레드끼리는 메모리를 공유할 수 있어 여러 가지 작업을 동시에 수행할 수 있다.
- 자바스크립트 코드의 실행은 하나의 스레드에서 순차적으로 이루어진다. (Run-to-completion)
  - 동시성을 고민하지 않아도 된다는 장점
  - 하나의 작업이 끝나기 전까지는 다른 작업이 실행되지 않는다는 단점

> **자바스크립트는 왜 싱글 스레드로 설계됐을까?**
>
> - 멀티 스레드는 내부적으로 처리가 복잡하다. (예시: 동시성 문제)
>   - 메모리 공유로 인해 동시에 같은 자원에 접근하면 타이밍 이슈가 발생할 수 있고, DOM 표시에 큰 문제를 야기할 수 있다.
> - 하나의 스레드가 문제가 생기면 같은 자원을 공유하는 다른 스레드에도 동시에 문제가 일어날 수 있다.
> - 최초의 자바스크립트는 브라우저에서 HTML을 그리는데 한정적인 도움을 주는 보조적인 역할로 만들어졌다.

## 1.5.2 이벤트 루프란? 
### 호출 스택과 이벤트 루프
- 호출 스택(call stack): 자바스크립트에서 수행해야 할 코드나 함수를 순차적으로 담아두는 스택
- 이벤트 루프: 자바스크립트 런타임 외부에서 자바스크립트의 비동기 실행을 돕기 위해 만들어진 장치
  - 이벤트 루프의 단일 스레드 내부에서 호출 스택 내부에 수행해야 할 작업이 있는지 확인하고, 수행해야 할 코드가 있다면 자바스크립트 엔진을 이용해 실행
  - 코드 실행과 호출 스택 확인이 모두 단일 스레드에서 일어나기 때문에 동시에 일어날 수 없으며 한 스레드에서 순차적으로 일어난다.
  - 이벤트 루프는 한 개 이상의 태스크 큐(실행해야 할 태스크의 집합)를 가지고 있다.
- 태스크 큐: 선택된 큐 중에서 실행 가능한(비동기 함수의 콜백 함수나 이벤트 핸들러 등) 가장 오래된 태스크를 가져오는 set
  - 비동기 함수는 메인 스레드가 아닌 태스크 큐가 할당되는 별도의 스레드에서 수행된다.
  - 이 별도의 스레드에서 태스크 큐에 작업을 할당해 처리하는 것은 브라우저나 Node.js의 역할이다.
  - 자바스크립트 코드 실행은 싱글 스레드에서 이루어지지만 외부 Web API 등은 모두 자바스크립트 코드 외부에서 실행되고 콜백이 태스크 큐로 들어간다.

> **비동기 작업**
>
> ```js
> function bar() {
>   console.log('bar');
> }
>
> function baz() {
>   console.log('baz');
> }
>
> function foo() {
>   console.log('foo');
>   setTimeout(bar(), 0);
>   baz();
> }
>
> foo();
> ```
>
> 1. foo()가 호출 스택에 먼저 들어간다.
> 2. foo() 내부에 console.log가 존재하므로 호출 스택에 들어간다.
> 3. 2의 실행이 완료된 이후에 다음 코드로 넘어간다. (아직 foo()는 존재)
> 4. setTimeout(bar(), 0)이 호출 스택에 들어간다.
> 5. 4번에 대해 타이머 이벤트가 실행되며 태스크 큐로 들어가고, 그 대신 바로 스택에서 제거된다.
> 6. baz()가 호출 스택에 들어간다.
> 7. baz() 내부에 console.log가 존재하므로 호출 스택에 들어간다.
> 8. 7의 실행이 완료된 이후에 다음 코드로 넘어간다. (아직 foo(), baz()는 존재)
> 9. 더 이상 baz()에 남은 것이 없으므로 호출 스택에서 제거된다. (아직 foo()는 존재)
> 10. 더 이상 foo()에 남은 것이 없으므로 호출 스택에서 제거된다.
> 11. 이제 호출 스택이 완전히 비워졌다.
> 12. 이벤트 루프가 호춢 스택이 비워져 있다는 것을 확인했다. 그리고 태스크 큐를 확인하니 4번에 들어갔던 내용이 있어 bar()를 호출 스택에 들여보낸다.
> 13. bar() 내부에 console.log가 존재하므로 호출 스택에 들어간다.
> 14. 13의 실행이 끝나고, 다음 코드로 넘어간다. (아직 bar()는 존재)
> 15. 더 이상 bar()에 남은 것이 없으므로 호출 스택에서 제거된다.

## 1.5.3 태스크 큐와 마이크로 태스크 큐 
- 매크로태스큐(Macro Task Queue) = 태스크 큐 
- 이벤트 루프는 하나의 마이크로 태스크 큐를 갖는다. (예시: Promise)
- 마이크로 태스크 큐는 기존 태스크 큐보다 우선권을 갖는다. → 마이크로 태스크 큐가 빌 때 까지는 기존 태스크 큐의 실행을 뒤로 미룬다.
- 렌더링은 마이크로 태스크 큐 작업이 끝난 후 발생한다.
- 마이크로 태스크 큐 > 렌더링 > 태스크 큐

> 태스크 큐: `setTimeout`, `setInterval`, `setImmediate`  
> 마이크로 태스크 큐: `process.nextTick`, `Promise`, `queueMicroTask`, `MutationObserver`

## 1.5.4 정리 
자바스크립트 코드를 실행하는 것 자체는 싱글 스레드로 이루어져서 비동기를 처리하기 어렵지만 자바스크립트 코드를 실행하는 것 이외에 태스크큐, 이벤트루프, 마이크로 태스크 큐, 브라우저/Nodejs API 등이 적절한 생태계를 이루고 있기 때문에 싱글 스레드로는 불가능한 비동기 이벤트 처리가 가능해진 것이다. 
